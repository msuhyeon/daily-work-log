## Tanstack Query 설정 옵션
- [staleTime](#staletime)
- [networkMode](#networkmode)


## staleTime
- **캐시에 저장된 데이터가 최신이라고 간주하는 기간**.
- 이 시간 동안은 API 재호출을 하지 않고 캐시 데이터를 그대로 사용.
- 기본값: `0` (가져오자마자 바로 stale 상태가 됨 👉 매번 refetch 발생).


### 동작 방식
1. `staleTime` 이내  
   - 데이터는 **fresh** 상태.  
   - 같은 `queryKey`를 쓰는 다른 컴포넌트에서 API 재호출 없이 캐시 값 재사용.  

2. `staleTime` 이후  
   - 데이터는 **stale** 상태.  
   - 캐시된 값은 먼저 보여주고, 동시에 **백그라운드에서 API refetch** 실행.  


```ts
export const useApples = () => {
  return useQuery({
    queryKey: ['apples'],
    queryFn: () => appleApi.getApples(),
    staleTime: 1000 * 60 * 5, // 5분 동안 "최신"으로 간주됨
    // 5분 이후엔 캐시된 데이터 보여주면서 백그라운드에서 API 재호출 -> 캐시를 구독하고 있는 컴포넌트들이 자동으로 리렌더링
  });
};
```

#### 설정 기준
`staleTime`은 데이터의 변경 빈도와 최신성의 중요도에 따라 달라지며, 참고할 수 있는 가이드라인을 정리해봤다.

- 실시간 데이터: 주식, 채팅
  - staleTime: 0초 ~ n초
- 자주 변하는 리스트: 빠르게 갱신되는 데이터 목록
  - staleTime: 30초 ~ 1분 
- 일반 목록 데이터: 상품, 기관 리스트
  - staleTime: 1분 ~ 5분 
- 거의 변하지 않는 데이터: 국가 코드, 설정값
  - staleTime: 30분 ~ 하루


## networkMode
네트워크 상태에 따른 요청 처리 방식을 제어하는 옵션

### 1. `'online'` (기본값)
```typescript
networkMode: 'online'
```
- **동작**: 온라인일 때만 요청 실행
- **오프라인일 때**: 요청을 일시 중단하고 네트워크 복구까지 대기
- **복구 시**: 자동으로 중단된 요청들이 재개됨
- **사용 케이스**: 일반적인 대부분의 상황 (기본 동작)

### 2. `'always'` 👈 개발 중 사용한 옵션
```typescript
networkMode: 'always'
```
- React Query는 기본적으로 네트워크가 오프라인일 때 요청을 일시 중단함
- `networkMode: 'always'`는 네트워크 상태와 관계없이 **항상 요청을 실행**하는 모드
- 오프라인 상황에서도 즉시 실패 처리하여 사용자에게 명확한 피드백 제공

#### 사용한 이유
- **즉각적인 에러 피드백이 필요할 때**: 사용자가 오프라인 시 토스트 에러 메시지 노출 필요
- **중요한 사용자 액션**: 폼 제출, 결제, 데이터 생성 등 실패 여부를 바로 확인해야 함
- **UX 일관성**: 네트워크 상태에 따른 예측 불가능한 지연 없이 일관된 응답 제공 필요

#### 적용 내용
**파일**: `src/pages/_app.tsx`
- QueryClient 전역 설정에서 mutations 기본 옵션 정의
- 모든 useMutation hooks에 공통으로 적용되도록 구성

```typescript
mutations: {
  networkMode: 'always', // 오프라인에서도 즉시 에러 반환
  retry: false,          // mutation 재시도 비활성화: 네트워크 복구 시 중복 실행 방지
},
```

#### 개선 효과
- **안정성**: 네트워크 불안정 상황에서 중복 요청 방지
- **사용성**: 명확한 에러 피드백과 수동 제어 가능
- **성능**: 불필요한 재시도 요청 제거

### 3. `'offlineFirst'`
```typescript
networkMode: 'offlineFirst'
```
- **동작**: 오프라인에서도 실행하되 캐시를 우선 사용
- **오프라인일 때**: 캐시된 데이터가 있으면 그것을 사용, 없으면 요청 실행
- **장점**: 오프라인에서도 앱이 계속 동작
- **사용 케이스**: PWA, 오프라인 우선 앱

## 옵션 비교표

| 옵션 | 온라인 | 오프라인 캐시 있음 | 오프라인 캐시 없음 |
|------|--------|-------------------|-------------------|
| `'online'` | 요청 실행 | 대기 후 복구 시 실행 | 대기 후 복구 시 실행 |
| `'always'` | 요청 실행 | 즉시 요청 실행 (실패) | 즉시 요청 실행 (실패) |
| `'offlineFirst'` | 요청 실행 | 캐시 사용 | 요청 실행 (실패 가능) |
